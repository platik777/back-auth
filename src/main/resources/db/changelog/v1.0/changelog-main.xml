<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Включение расширения UUID для PostgreSQL -->
    <changeSet id="initial-0" author="developer">
        <sql>CREATE EXTENSION IF NOT EXISTS "uuid-ossp";</sql>
    </changeSet>

    <!-- Создание таблицы users -->
    <changeSet id="initial-1" author="developer">
        <createTable tableName="users">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="login" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="settings" type="JSONB"/>
            <column name="account_type" type="VARCHAR(255)"/>
            <column name="password_hash" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints unique="true"/>
            </column>
            <column name="phone" type="VARCHAR(50)"/>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- Создание таблицы tenant -->
    <changeSet id="initial-2" author="developer">
        <createTable tableName="tenant">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="owner_id" type="VARCHAR(255)">
                <constraints nullable="false" foreignKeyName="fk_tenant_owner" references="users(id)"/>
            </column>
            <column name="bank_name" type="VARCHAR(255)"/>
            <column name="account_number" type="VARCHAR(100)"/>
            <column name="bic" type="VARCHAR(50)"/>
            <column name="kpp_bank" type="VARCHAR(50)"/>
            <column name="tax_bank" type="VARCHAR(50)"/>
            <column name="correspondent_account" type="VARCHAR(100)"/>
            <column name="full_title" type="VARCHAR(500)"/>
            <column name="ogrn" type="VARCHAR(50)"/>
            <column name="ogrnip" type="VARCHAR(50)"/>
            <column name="kpp" type="VARCHAR(50)"/>
            <column name="legal_address" type="TEXT"/>
            <column name="post_address" type="TEXT"/>
            <column name="tax_number" type="VARCHAR(50)"/>
            <column name="country" type="VARCHAR(100)"/>
            <column name="kio" type="VARCHAR(50)"/>
            <column name="license_number" type="VARCHAR(100)"/>
            <column name="license_issue_date" type="DATE"/>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- Создание таблицы group -->
    <changeSet id="initial-3" author="developer">
        <createTable tableName="groups">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="creator_id" type="VARCHAR(255)">
                <constraints foreignKeyName="fk_group_creator" references="users(id)"/>
            </column>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- Создание таблицы group_user (связь многие-ко-многим между users и groups) -->
    <changeSet id="initial-4" author="developer">
        <createTable tableName="group_user">
            <column name="group_id" type="VARCHAR(255)">
                <constraints nullable="false" foreignKeyName="fk_group_user_group" references="groups(id)" deleteCascade="true"/>
            </column>
            <column name="user_id" type="VARCHAR(255)">
                <constraints nullable="false" foreignKeyName="fk_group_user_user" references="users(id)" deleteCascade="true"/>
            </column>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>

        <!-- Составной первичный ключ -->
        <addPrimaryKey tableName="group_user" columnNames="group_id, user_id" constraintName="pk_group_user"/>
    </changeSet>

    <!-- Создание таблицы folders -->
    <changeSet id="initial-5" author="developer">
        <createTable tableName="folders">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="parent_id" type="VARCHAR(255)"/>
            <column name="all_parant_ids" type="TEXT[]"/>
            <column name="rank" type="INTEGER"/>
            <column name="has_children" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="item_types" type="TEXT[]"/>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="folders"
                baseColumnNames="parent_id"
                constraintName="fk_folder_parent"
                referencedTableName="folders"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <!-- Создание таблицы projects -->
    <changeSet id="initial-6" author="developer">
        <createTable tableName="projects">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="folder_id" type="VARCHAR(255)">
                <constraints nullable="false" foreignKeyName="fk_project_folder" references="folders(id)" deleteCascade="true"/>
            </column>
            <column name="all_parant_ids" type="TEXT[]"/>
            <column name="rank" type="INTEGER"/>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="BOOLEAN"/>
            <column name="data" type="JSONB"/>
            <column name="favourite" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="preview" type="VARCHAR(500)"/>
            <column name="type" type="VARCHAR(100)"/>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- Создание таблицы deltas -->
    <changeSet id="initial-7" author="developer">
        <createTable tableName="deltas">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="project_id" type="VARCHAR(255)">
                <constraints nullable="false" foreignKeyName="fk_delta_project" references="projects(id)" deleteCascade="true"/>
            </column>
            <column name="number_version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="comment" type="TEXT"/>
            <column name="is_parent" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="delta" type="JSONB"/>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- Создание таблицы blocks -->
    <changeSet id="initial-8" author="developer">
        <createTable tableName="blocks">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="all_parant_ids" type="TEXT[]"/>
            <column name="rank" type="INTEGER"/>
            <column name="name" type="VARCHAR(255)"/>
            <column name="data" type="JSONB"/>
            <column name="state" type="BOOLEAN"/>
            <column name="locale" type="VARCHAR(10)"/>
            <column name="category_id" type="VARCHAR(255)"/>
            <column name="image" type="VARCHAR(500)"/>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- Создание таблицы image -->
    <changeSet id="initial-9" author="developer">
        <createTable tableName="images">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="block_id" type="VARCHAR(255)">
                <constraints nullable="false" foreignKeyName="fk_image_block" references="blocks(id)" deleteCascade="true"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="file" type="BYTEA"/>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- Создание таблицы files -->
    <changeSet id="initial-10" author="developer">
        <createTable tableName="files">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="file" type="BYTEA"/>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(100)"/>
            <column name="content_type" type="VARCHAR(100)"/>
            <column name="size" type="BIGINT"/>
            <column name="all_parant_ids" type="TEXT[]"/>
            <column name="rank" type="INTEGER"/>
            <column name="folder_id" type="VARCHAR(255)">
                <constraints nullable="false" foreignKeyName="fk_file_folder" references="folders(id)" deleteCascade="true"/>
            </column>

            <!-- Поля из BaseEntity -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="TIMESTAMP"/>
            <column name="updated_by" type="TIMESTAMP"/>
            <column name="tenant_id" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

</databaseChangeLog>
