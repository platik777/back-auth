<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Создание индексов для оптимизации -->
    <changeSet id="indexes-1" author="developer">
        <!-- Индексы для user -->
        <createIndex tableName="user" indexName="idx_user_email">
            <column name="email"/>
        </createIndex>

        <createIndex tableName="user" indexName="idx_user_login">
            <column name="login"/>
        </createIndex>

        <createIndex tableName="user" indexName="idx_user_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <!-- Индексы для tenant -->
        <createIndex tableName="tenant" indexName="idx_tenant_owner">
            <column name="owner_id"/>
        </createIndex>

        <!-- Индексы для group -->
        <createIndex tableName="group" indexName="idx_group_creator">
            <column name="creator_id"/>
        </createIndex>

        <createIndex tableName="group" indexName="idx_group_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <!-- Индексы для group_user -->
        <createIndex tableName="group_user" indexName="idx_group_user_group">
            <column name="group_id"/>
        </createIndex>

        <createIndex tableName="group_user" indexName="idx_group_user_user">
            <column name="user_id"/>
        </createIndex>

        <!-- Индексы для folder -->
        <createIndex tableName="folder" indexName="idx_folder_parent">
            <column name="parent_id"/>
        </createIndex>

        <createIndex tableName="folder" indexName="idx_folder_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <!-- Индексы для project -->
        <createIndex tableName="project" indexName="idx_project_folder">
            <column name="folder_id"/>
        </createIndex>

        <createIndex tableName="project" indexName="idx_project_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <createIndex tableName="project" indexName="idx_project_type">
            <column name="type"/>
        </createIndex>

        <createIndex tableName="project" indexName="idx_project_status">
            <column name="status"/>
        </createIndex>

        <!-- Индексы для delta -->
        <createIndex tableName="delta" indexName="idx_delta_project">
            <column name="project_id"/>
        </createIndex>

        <createIndex tableName="delta" indexName="idx_delta_project_version">
            <column name="project_id"/>
            <column name="number_version"/>
        </createIndex>

        <!-- Индексы для block -->
        <createIndex tableName="block" indexName="idx_block_category">
            <column name="category_id"/>
        </createIndex>

        <createIndex tableName="block" indexName="idx_block_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <createIndex tableName="block" indexName="idx_block_folder">
            <column name="folder_id"/>
        </createIndex>

        <!-- Индексы для image -->
        <createIndex tableName="block" indexName="idx_image_block">
            <column name="image_id"/>
        </createIndex>

        <createIndex tableName="image" indexName="idx_image_active">
            <column name="is_active"/>
        </createIndex>

        <!-- Индексы для file -->
        <createIndex tableName="file" indexName="idx_file_folder">
            <column name="folder_id"/>
        </createIndex>

        <createIndex tableName="file" indexName="idx_file_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <!-- Индексы для item_user_permission -->
        <createIndex tableName="item_user_permission" indexName="idx_permission_user">
            <column name="user_id"/>
        </createIndex>

        <createIndex tableName="item_user_permission" indexName="idx_permission_project">
            <column name="project_id"/>
        </createIndex>

        <createIndex tableName="item_user_permission" indexName="idx_permission_folder">
            <column name="folder_id"/>
        </createIndex>

        <createIndex tableName="item_user_permission" indexName="idx_permission_file">
            <column name="file_id"/>
        </createIndex>

        <createIndex tableName="item_user_permission" indexName="idx_permission_block">
            <column name="block_id"/>
        </createIndex>

        <!-- Индексы для item_group_permission -->
        <createIndex tableName="item_group_permission" indexName="idx_group_permission_group">
            <column name="group_id"/>
        </createIndex>

        <createIndex tableName="item_group_permission" indexName="idx_group_permission_project">
            <column name="project_id"/>
        </createIndex>

        <createIndex tableName="item_group_permission" indexName="idx_group_permission_folder">
            <column name="folder_id"/>
        </createIndex>

        <createIndex tableName="item_group_permission" indexName="idx_group_permission_file">
            <column name="file_id"/>
        </createIndex>

        <createIndex tableName="item_group_permission" indexName="idx_group_permission_block">
            <column name="block_id"/>
        </createIndex>

        <!-- Индексы для api_key -->
        <createIndex tableName="api_key" indexName="idx_apikey_user">
            <column name="user_id"/>
        </createIndex>

        <createIndex tableName="api_key" indexName="idx_apikey_key">
            <column name="api_key"/>
        </createIndex>
    </changeSet>

    <!-- GIN индексы для JSONB полей -->
    <changeSet id="indexes-2" author="developer">
        <sql>CREATE INDEX idx_user_settings ON "user" USING GIN (settings);</sql>
        <sql>CREATE INDEX idx_block_data ON block USING GIN (block_data);</sql>
        <sql>CREATE INDEX idx_delta_delta ON delta USING GIN (delta);</sql>
    </changeSet>

    <!-- GIN индексы для массивов -->
    <changeSet id="indexes-3" author="developer">
        <sql>CREATE INDEX idx_folder_all_parent_ids ON folder USING GIN (all_parent_ids);</sql>
        <sql>CREATE INDEX idx_project_all_parent_ids ON project USING GIN (all_parent_ids);</sql>
        <sql>CREATE INDEX idx_block_all_parent_ids ON block USING GIN (all_parent_ids);</sql>
        <sql>CREATE INDEX idx_file_all_parent_ids ON file USING GIN (all_parent_ids);</sql>
    </changeSet>

    <!-- Уникальные partial индексы для гарантии уникальности permission на item для пользователя -->
    <changeSet id="indexes-4" author="developer">
        <sql>
            CREATE UNIQUE INDEX idx_unique_permission_user_project
                ON item_user_permission (user_id, project_id)
                WHERE project_id IS NOT NULL;
        </sql>
        <sql>
            CREATE UNIQUE INDEX idx_unique_permission_user_folder
                ON item_user_permission (user_id, folder_id)
                WHERE folder_id IS NOT NULL;
        </sql>
        <sql>
            CREATE UNIQUE INDEX idx_unique_permission_user_file
                ON item_user_permission (user_id, file_id)
                WHERE file_id IS NOT NULL;
        </sql>
        <sql>
            CREATE UNIQUE INDEX idx_unique_permission_user_block
                ON item_user_permission (user_id, block_id)
                WHERE block_id IS NOT NULL;
        </sql>
    </changeSet>

    <!-- Уникальные partial индексы для гарантии уникальности permission на item для группы -->
    <changeSet id="indexes-5" author="developer">
        <sql>
            CREATE UNIQUE INDEX idx_unique_permission_group_project
                ON item_group_permission (group_id, project_id)
                WHERE project_id IS NOT NULL;
        </sql>
        <sql>
            CREATE UNIQUE INDEX idx_unique_permission_group_folder
                ON item_group_permission (group_id, folder_id)
                WHERE folder_id IS NOT NULL;
        </sql>
        <sql>
            CREATE UNIQUE INDEX idx_unique_permission_group_file
                ON item_group_permission (group_id, file_id)
                WHERE file_id IS NOT NULL;
        </sql>
        <sql>
            CREATE UNIQUE INDEX idx_unique_permission_group_block
                ON item_group_permission (group_id, block_id)
                WHERE block_id IS NOT NULL;
        </sql>
    </changeSet>

</databaseChangeLog>